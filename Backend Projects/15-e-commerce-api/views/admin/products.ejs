<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard - Products</title>
  <link rel="stylesheet" href="./css/admin/products.css">
</head>

<body>
  <header>
    <div>Admin Dashboard</div>
    <div>
      <a href="/users">Users</a>
      <a href="/products">Products</a>
      <a href="/logout">Logout</a>
    </div>
  </header>

  <h1>Products</h1>
  <div id="message"></div>

  <table>
    <thead>
      <tr>
        <th>Name</th>
        <th>Description</th>
        <th>Price</th>
        <th>Stock</th>
        <th>Image URL</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      <!-- New Product Row -->
      <tr id="new-product-row">
        <td><input type="text" id="new-name" placeholder="Name"></td>
        <td><input type="text" id="new-description" placeholder="Description"></td>
        <td><input type="number" id="new-price" placeholder="Price"></td>
        <td><input type="number" id="new-stock" placeholder="Stock"></td>
        <td><input type="text" id="new-imageUrl" placeholder="Image URL"></td>
        <td><button onclick="createProduct()">Add</button></td>
      </tr>

      <% products.forEach(product=> { %>
        <tr data-id="<%= product._id %>">
          <td data-label="Name"><input type="text" name="name" value="<%= product.name %>"></td>
          <td data-label="Description"><input type="text" name="description" value="<%= product.description %>"></td>
          <td data-label="Price"><input type="number" name="price" value="<%= product.price %>"></td>
          <td data-label="Stock"><input type="number" name="stock" value="<%= product.stock %>"></td>
          <td data-label="Image URL"><input type="text" name="imageUrl" value="<%= product.imageUrl %>"></td>
          <td data-label="Actions">
            <button onclick="updateProduct('<%= product._id %>', this)">Save</button>
            <button onclick="deleteProduct('<%= product._id %>', this)">Delete</button>
          </td>
        </tr>
        <% }) %>
    </tbody>
  </table>

  <script>
    async function updateProduct(id, btn) {
      const row = btn.closest('tr');
      const data = {
        name: row.querySelector('input[name="name"]').value,
        description: row.querySelector('input[name="description"]').value,
        price: parseFloat(row.querySelector('input[name="price"]').value),
        stock: parseInt(row.querySelector('input[name="stock"]').value),
        imageUrl: row.querySelector('input[name="imageUrl"]').value
      };
      try {
        const res = await fetch('/products/' + id, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const result = await res.json();
        showMessage(result.message, res.ok);
      } catch (err) { console.error(err); }
    }

    async function deleteProduct(id, btn) {
      if (!confirm("Are you sure you want to delete this product?")) return;
      try {
        const res = await fetch('/products/' + id, { method: 'DELETE' });
        const result = await res.json();
        showMessage(result.message, res.ok);
        if (res.ok) btn.closest('tr').remove();
      } catch (err) { console.error(err); }
    }

    async function createProduct() {
      const data = {
        name: document.getElementById('new-name').value,
        description: document.getElementById('new-description').value,
        price: parseFloat(document.getElementById('new-price').value),
        stock: parseInt(document.getElementById('new-stock').value),
        imageUrl: document.getElementById('new-imageUrl').value
      };

      try {
        const res = await fetch('/products', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const result = await res.json();
        showMessage(result.message, res.ok);
        if (res.ok) {
          location.reload(); // reload to show new product in table
        }
      } catch (err) { console.error(err); }
    }

    function showMessage(msg, success) {
      const div = document.getElementById('message');
      div.innerHTML = '<div class="' + (success ? 'success' : 'error') + '">' + msg + '</div>';
      setTimeout(() => { div.innerHTML = ''; }, 3000);
    }
  </script>
</body>

</html>